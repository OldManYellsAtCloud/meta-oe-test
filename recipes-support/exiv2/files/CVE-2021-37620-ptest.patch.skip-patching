From 004f2a2447c3d5d1d178fb5d9e961a1b4c26dc98 Mon Sep 17 00:00:00 2001
From: Kevin Backhouse <kevinbackhouse@github.com>
Date: Sat, 10 Jul 2021 10:41:53 +0100
Subject: [PATCH 1/3] Regression test for
 https://github.com/Exiv2/exiv2/security/advisories/GHSA-v5g7-46xf-h728

CVE: CVE-2021-37620
Upstream-Status: Backport [https://github.com/Exiv2/exiv2/commit/004f2a2447c3d5d1d178fb5d9e961a1b4c26dc98]
Signed-off-by: Gyorgy Sarvari <skandigraun@gmail.com>
---
 test/data/issue_ghsa_v5g7_46xf_h728_poc.exv   | Bin 0 -> 276 bytes
 .../github/test_issue_ghsa_v5g7_46xf_h728.py  |  18 ++++++++++++++++++
 2 files changed, 18 insertions(+)
 create mode 100755 test/data/issue_ghsa_v5g7_46xf_h728_poc.exv
 create mode 100644 tests/bugfixes/github/test_issue_ghsa_v5g7_46xf_h728.py

diff --git a/test/data/issue_ghsa_v5g7_46xf_h728_poc.exv b/test/data/issue_ghsa_v5g7_46xf_h728_poc.exv
new file mode 100755
index 0000000000000000000000000000000000000000..3e13b27a48c737c1b1c137acbb6ee878216505f2
GIT binary patch
literal 276
zcmX|7%WA_g5Ol9O_XC7-w&f@yiH&6+YI@5hP{>t@H;HjA30Yu;d|IyloI*dLk(<ZD
z!p<@~%xqRTE%psqw1Z<UIsUyC`6P3xYjq1&AlH7&E_ED>O6?%^^SCA${Znki@pk=#
zK9srhTFn8mh(&R@#`y$graGjX^7EnN5yz*$XZ3v_UFMN8M>0#2gv69k8U{gty0f&x
zg|eHDDtDO@y1l8jt(8Qh>@W-lgoV;K$M&p&zXkN&pT{($GxjALsg`UtU$7-6qZ#sW
Q;}eosL=Rq109h6J4JxT#4gdfE

literal 0
HcmV?d00001

diff --git a/tests/bugfixes/github/test_issue_ghsa_v5g7_46xf_h728.py b/tests/bugfixes/github/test_issue_ghsa_v5g7_46xf_h728.py
new file mode 100644
index 0000000000..de68afc222
--- /dev/null
+++ b/tests/bugfixes/github/test_issue_ghsa_v5g7_46xf_h728.py
@@ -0,0 +1,18 @@
+# -*- coding: utf-8 -*-
+
+from system_tests import CaseMeta, CopyTmpFiles, path, check_no_ASAN_UBSAN_errors
+
+class Jp2ImageEncodeJp2HeaderOutOfBoundsRead2(metaclass=CaseMeta):
+    """
+    Regression test for the bug described in:
+    https://github.com/Exiv2/exiv2/security/advisories/GHSA-v5g7-46xf-h728
+    """
+    url = "https://github.com/Exiv2/exiv2/security/advisories/GHSA-v5g7-46xf-h728"
+
+    filename = path("$data_path/issue_ghsa_v5g7_46xf_h728_poc.exv")
+    commands = ["$exiv2 $filename"]
+    stdout = [""]
+    stderr = ["""Exiv2 exception in print action for file $filename:
+Invalid XmpText type `'
+"""]
+    retval = [1]
