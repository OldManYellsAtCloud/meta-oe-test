From 0738294f773b3710b300ea4dd9a79189996381e1 Mon Sep 17 00:00:00 2001
From: Kevin Backhouse <kevinbackhouse@github.com>
Date: Tue, 13 Jul 2021 17:55:35 +0100
Subject: [PATCH 1/3] Regression test for
 https://github.com/Exiv2/exiv2/security/advisories/GHSA-m479-7frc-gqqg

Upstream-Status: Backport [https://github.com/Exiv2/exiv2/commit/0738294f773b3710b300ea4dd9a79189996381e1]
Signed-off-by: Gyorgy Sarvari
---
 test/data/issue_ghsa_m479_7frc_gqqg_poc.crw   | Bin 0 -> 22 bytes
 .../github/test_issue_ghsa_m479_7frc_gqqg.py  |  18 ++++++++++++++++++
 2 files changed, 18 insertions(+)
 create mode 100644 test/data/issue_ghsa_m479_7frc_gqqg_poc.crw
 create mode 100644 tests/bugfixes/github/test_issue_ghsa_m479_7frc_gqqg.py

diff --git a/test/data/issue_ghsa_m479_7frc_gqqg_poc.crw b/test/data/issue_ghsa_m479_7frc_gqqg_poc.crw
new file mode 100644
index 0000000000000000000000000000000000000000..b03321f14e5f4e1281124be3b595af02347581f6
GIT binary patch
literal 22
TcmebEWzb?^VBiB{7yz;X5g!2I

literal 0
HcmV?d00001

diff --git a/tests/bugfixes/github/test_issue_ghsa_m479_7frc_gqqg.py b/tests/bugfixes/github/test_issue_ghsa_m479_7frc_gqqg.py
new file mode 100644
index 0000000000..204bd31bd7
--- /dev/null
+++ b/tests/bugfixes/github/test_issue_ghsa_m479_7frc_gqqg.py
@@ -0,0 +1,18 @@
+# -*- coding: utf-8 -*-
+
+from system_tests import CaseMeta, path, check_no_ASAN_UBSAN_errors
+
+class ImagePrintIFDStructure(metaclass=CaseMeta):
+    """
+    Regression test for the bug described in:
+    https://github.com/Exiv2/exiv2/security/advisories/GHSA-m479-7frc-gqqg
+    """
+    url = "https://github.com/Exiv2/exiv2/security/advisories/GHSA-m479-7frc-gqqg"
+
+    filename = path("$data_path/issue_ghsa_m479_7frc_gqqg_poc.crw")
+    commands = ["$exiv2 -p C $filename"]
+    stdout = [""]
+    stderr = ["""Exiv2 exception in print action for file $filename:
+$kerCorruptedMetadata
+"""]
+    retval = [1]
